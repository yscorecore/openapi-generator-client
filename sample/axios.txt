import axios, { AxiosRequestConfig, AxiosInstance } from 'axios';


export interface RestInfo {
    url: string,
    method: string,
    headers?: { [key: string]: any },
    forms?: { [key: string]: any },
    params?: { [key: string]: any },
    body?: any,
}

export class ApiCodeError extends Error {
    public code: string;
    constructor(code: string, message: string) {
        super(message);
        this.code = code;
        this.name = this.constructor.name; 
        Object.setPrototypeOf(this, ApiCodeError.prototype);
    }
}

export const axiosInstance: AxiosInstance = axios.create();

const multipartFormDataHeader = { 'Content-type': 'multipart/form-data' };
const applicationJsonDataHeader = { 'Content-type': 'application/json' }
const formUrlEncodedHeader = { 'Content-type': 'application/x-www-form-urlencoded' }

function paramsSerializer(params: any): string {
    let entries = Object.entries(params || {}).flatMap(([k, v]) => {
        // 跳过undefined的参数
        if (v === undefined) {
            return [];
        }

        if (Array.isArray(v)) {
            return v.map(t => [k, t]);
        } else if (v instanceof Object) {
            return Object.entries(v);
        } else {
            return [[k, v]];
        }
    }
    );
    let segments = entries.map(p => `${p[0]}=${encodeURIComponent(p[1] ?? '')}`);
    return segments.join('&');
}
function buildUrlEncodedFormRequest(req: RestInfo): AxiosRequestConfig<any> {
    return {
        url: req.url,
        method: req.method,
        headers: { ...formUrlEncodedHeader, ...req.headers },
        params: { ...req.params, ...req.forms },
        paramsSerializer: {
            serialize: paramsSerializer
        }
    }
}
function buildMultipartFormDataFormRequest(req: RestInfo): AxiosRequestConfig<any> {
    return {
        url: req.url,
        method: req.method,
        headers: { ...multipartFormDataHeader, ...req.headers },
        params: req.params,
        data: req.forms,
        paramsSerializer: {
            serialize: paramsSerializer
        }
    }
}
function buildCommonRequest(req: RestInfo): AxiosRequestConfig<any> {
    return {
        url: req.url,
        method: req.method,
        headers: { ...applicationJsonDataHeader, ...req.headers },
        params: req.params,
        data: req.body,
        paramsSerializer: {
            serialize: paramsSerializer
        },
    };
}
function isCodeMessageResponse(responseData: any): boolean {
    return responseData.code !== undefined && responseData.message !== undefined;
}
function isSuccessCode(code: any): boolean {
    return code === '0';
}
function extractData(responseData: any): any {
    if (isCodeMessageResponse(responseData)) {
        if (isSuccessCode(responseData.code)) {
            return responseData.data;
        } else {
            throw new ApiCodeError(String(responseData.code), String(responseData.message));
        }
    } else {
        return responseData;
    }
}
export async function send<T>(req: RestInfo): Promise<T> {
    let reqInfo = req.forms ? (
        req.method.toLowerCase() === "get" ? buildUrlEncodedFormRequest(req)
            : buildMultipartFormDataFormRequest(req))
        : buildCommonRequest(req);
    const res = await axiosInstance.request(reqInfo);
    return extractData(res.data);
}